local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Camera = game.Workspace.CurrentCamera

local Config = {
    AIMBOT_ENABLED = false,
    TARGET_PART = "HumanoidRootPart",
    MAX_DISTANCE = 500,
    SMOOTHNESS = 0.3,
    UPDATE_INTERVAL = 0.1,
    FOV = 180,
    PREDICTION_MULTIPLIER = 1.5,
    ROLE_COLORS = {
        Sheriff = Color3.fromRGB(0, 0, 255),
        Murder = Color3.fromRGB(255, 0, 0),
        Innocent = Color3.fromRGB(0, 255, 0),
        GunDrop = Color3.fromRGB(255, 255, 0)
    }
}

local Cache = {
    lastUpdate = 0,
    lastValidRoles = {},
    confirmedMurderer = nil,
    espCache = {},
    gunDropCache = {},
    connections = {}
}

-- Utility Functions
local function safeFunction(fn)
    return function(...)
        local success, err = pcall(fn, ...)
        if not success then
            warn("Error in function:", err)
        end
    end
end

-- Role Detection Functions
local function isMurderer(player)
    if not player or not player.Character then return false end
    if not player.Backpack then return false end
    
    local hasKnifeInBackpack = player.Backpack:FindFirstChild("Knife")
    local hasKnifeInCharacter = player.Character:FindFirstChild("Knife")
    return hasKnifeInBackpack or hasKnifeInCharacter
end

local function findMurderer()
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= Players.LocalPlayer and isMurderer(player) then
            return player
        end
    end
    return nil
end

-- Aimbot Functions
local function isInRange(target)
    if not target then return false end
    
    local localPlayer = Players.LocalPlayer
    if not localPlayer then return false end
    
    local character = localPlayer.Character
    if not character then return false end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return false end
    
    local distance = (target.Position - humanoidRootPart.Position).Magnitude
    return distance <= Config.MAX_DISTANCE
end

local function lookAt(position)
    local localPlayer = Players.LocalPlayer
    if not localPlayer then return end
    
    local character = localPlayer.Character
    if not character then return end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return end
    
    -- Get current mouse position and check FOV
    local mouseLocation = UserInputService:GetMouseLocation()
    local targetScreenPosition, isOnScreen = Camera:WorldToScreenPoint(position)
    
    if not isOnScreen then return end
    
    -- Calculate distance from cursor to target
    local distanceFromCursor = (Vector2.new(mouseLocation.X, mouseLocation.Y) - 
                               Vector2.new(targetScreenPosition.X, targetScreenPosition.Y)).Magnitude
    
    if distanceFromCursor > Config.FOV then return end
    
    -- Calculate aim direction with smoothing
    local targetPosition = position
    local cameraPosition = Camera.CFrame.Position
    local lookVector = (targetPosition - cameraPosition).Unit
    
    local currentCFrame = Camera.CFrame
    local targetCFrame = CFrame.new(cameraPosition, targetPosition)
    local smoothCFrame = currentCFrame:Lerp(targetCFrame, Config.SMOOTHNESS)
    
    Camera.CFrame = smoothCFrame
end

-- UI Functions
local function createToggleButton()
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "AimbotToggle"
    ScreenGui.ResetOnSpawn = false

    local ToggleButton = Instance.new("TextButton")
    ToggleButton.Name = "ToggleButton"
    ToggleButton.Size = UDim2.new(0, 150, 0, 50)
    ToggleButton.Position = UDim2.new(1, -200, 0, 50)
    ToggleButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
    ToggleButton.Text = "OFF"
    ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    ToggleButton.Font = Enum.Font.SourceSansBold
    ToggleButton.TextSize = 16
    ToggleButton.BorderSizePixel = 2
    ToggleButton.BorderColor3 = Color3.fromRGB(0, 0, 0)
    ToggleButton.Parent = ScreenGui

    local UICorner = Instance.new("UICorner")
    UICorner.CornerRadius = UDim.new(0.2, 0)
    UICorner.Parent = ToggleButton

    local Shadow = Instance.new("ImageLabel")
    Shadow.Name = "Shadow"
    Shadow.BackgroundTransparency = 1
    Shadow.Image = "rbxassetid://1316045217"
    Shadow.ImageColor3 = Color3.fromRGB(0, 0, 0)
    Shadow.ImageTransparency = 0.6
    Shadow.Size = UDim2.new(1.2, 0, 1.2, 0)
    Shadow.Position = UDim2.new(-0.1, 0, -0.1, 0)
    Shadow.ZIndex = ToggleButton.ZIndex - 1
    Shadow.Parent = ToggleButton

    local function toggleAimbot()
        Config.AIMBOT_ENABLED = not Config.AIMBOT_ENABLED
        ToggleButton.Text = Config.AIMBOT_ENABLED and "ON" or "OFF"
        ToggleButton.BackgroundColor3 = Config.AIMBOT_ENABLED and 
            Color3.fromRGB(0, 255, 0) or 
            Color3.fromRGB(255, 0, 0)
    end

    ToggleButton.MouseButton1Click:Connect(toggleAimbot)
    
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if not gameProcessed and input.KeyCode == Enum.KeyCode.X then
            toggleAimbot()
        end
    end)

    if Players.LocalPlayer:WaitForChild("PlayerGui") then
        ScreenGui.Parent = Players.LocalPlayer.PlayerGui
    end
end

-- ESP Functions
local function createPlayerESP(player)
    if Cache.espCache[player] then return end
    
    local esp = Instance.new("BillboardGui")
    esp.Name = "ESP"
    esp.Size = UDim2.new(4, 0, 5.5, 0)
    esp.AlwaysOnTop = true
    esp.MaxDistance = Config.MAX_DISTANCE

    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 1, 0)
    frame.BackgroundTransparency = 0.2
    frame.BorderSizePixel = 2
    frame.Parent = esp

    local infoContainer = Instance.new("Frame")
    infoContainer.Size = UDim2.new(1, 0, 0.2, 0)
    infoContainer.Position = UDim2.new(0, 0, 0, 0)
    infoContainer.BackgroundColor3 = Color3.new(0, 0, 0)
    infoContainer.BackgroundTransparency = 0.2
    infoContainer.BorderSizePixel = 0
    infoContainer.Parent = frame

    local nameLabel = Instance.new("TextLabel")
    nameLabel.Size = UDim2.new(1, 0, 0.5, 0)
    nameLabel.Position = UDim2.new(0, 0, 0, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = player.Name
    nameLabel.TextColor3 = Color3.new(1, 1, 1)
    nameLabel.TextSize = 14
    nameLabel.Font = Enum.Font.SourceSansBold
    nameLabel.Parent = infoContainer

    local roleLabel = Instance.new("TextLabel")
    roleLabel.Size = UDim2.new(1, 0, 0.5, 0)
    roleLabel.Position = UDim2.new(0, 0, 0.5, 0)
    roleLabel.BackgroundTransparency = 1
    roleLabel.Text = "Unknown"
    roleLabel.TextColor3 = Color3.new(1, 1, 1)
    roleLabel.TextSize = 14
    roleLabel.Font = Enum.Font.SourceSansBold
    roleLabel.Parent = infoContainer

    Cache.espCache[player] = {
        esp = esp,
        frame = frame,
        nameLabel = nameLabel,
        roleLabel = roleLabel
    }
end

local function createGunDropESP(part)
    if Cache.gunDropCache[part] then return end
    
    local esp = Instance.new("BillboardGui")
    esp.Name = "GunESP"
    esp.Size = UDim2.new(2, 0, 2, 0)
    esp.AlwaysOnTop = true
    esp.MaxDistance = Config.MAX_DISTANCE
    
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 1, 0)
    frame.BackgroundColor3 = Config.ROLE_COLORS.GunDrop
    frame.BackgroundTransparency = 0.2
    frame.BorderSizePixel = 2
    frame.Parent = esp
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 0.25, 0)
    label.Position = UDim2.new(0, 0, -0.25, 0)
    label.BackgroundTransparency = 1
    label.Text = "GUN"
    label.TextColor3 = Color3.new(1, 1, 1)
    label.TextSize = 14
    label.Font = Enum.Font.SourceSansBold
    label.Parent = frame
    
    esp.Parent = part
    Cache.gunDropCache[part] = esp
end

local function detectPlayerRole(player)
    if not player.Character or not player.Backpack then return "Unknown" end
    
    local function hasItem(itemName)
        return player.Character:FindFirstChild(itemName) or 
               player.Backpack:FindFirstChild(itemName)
    end
    
    if hasItem("Knife") then
        Cache.confirmedMurderer = player
        return "Murder"
    end
    
    if hasItem("Gun") or hasItem("Revolver") then
        return "Sheriff"
    end
    
    if Cache.confirmedMurderer and Cache.confirmedMurderer ~= player then
        return "Innocent"
    end
    
    return "Unknown"
end

local function updatePlayerESP(player)
    local espData = Cache.espCache[player]
    if not espData then return end
    
    local character = player.Character
    if not character then return end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return end
    
    local role = detectPlayerRole(player)
    Cache.lastValidRoles[player] = role
    
    if role ~= "Unknown" then
        espData.frame.BorderColor3 = Config.ROLE_COLORS[role]
        espData.frame.BackgroundColor3 = Config.ROLE_COLORS[role]
        espData.roleLabel.Text = role
    else
        espData.frame.BorderColor3 = Color3.new(0.7, 0.7, 0.7)
        espData.frame.BackgroundColor3 = Color3.new(0.7, 0.7, 0.7)
        espData.roleLabel.Text = "Unknown"
    end
    
    espData.esp.Parent = humanoidRootPart
end

local function updateGunDrops()
    for part, esp in pairs(Cache.gunDropCache) do
        if not part:IsDescendantOf(workspace) then
            esp:Destroy()
            Cache.gunDropCache[part] = nil
        end
    end
    
    for _, descendant in ipairs(workspace:GetDescendants()) do
        if (descendant.Name == "GunDrop" or descendant.Name == "Gun") 
            and not descendant:IsDescendantOf(Players.LocalPlayer.Character)
            and not Cache.gunDropCache[descendant] then
            createGunDropESP(descendant)
        end
    end
end

-- Event Handlers
local function onPlayerRemoved(player)
    local espData = Cache.espCache[player]
    if espData then
        espData.esp:Destroy()
        Cache.espCache[player] = nil
    end
    Cache.lastValidRoles[player] = nil
    if Cache.confirmedMurderer == player then
        Cache.confirmedMurderer = nil
    end
end

local function onWorkspaceChanged(instance)
    if instance.Name == "GunDrop" or instance.Name == "Gun" then
        createGunDropESP(instance)
    end
end

-- Main Update Loop
local function mainUpdate()
    local currentTime = tick()
    
    if currentTime - Cache.lastUpdate >= Config.UPDATE_INTERVAL then
        Cache.lastUpdate = currentTime
        
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= Players.LocalPlayer then
                createPlayerESP(player)
                updatePlayerESP(player)
            end
        end
        
        if currentTime % 1 == 0 then
            updateGunDrops()
        end
    end
    
    if Config.AIMBOT_ENABLED then
        local murderer = findMurderer()
        if murderer and murderer.Character then
            local targetPart = murderer.Character:FindFirstChild(Config.TARGET_PART)
            local humanoid = murderer.Character:FindFirstChild("Humanoid")
            
            if targetPart and humanoid and humanoid.Health > 0 and isInRange(targetPart) then
                local velocity = humanoid.MoveDirection * humanoid.WalkSpeed
                local predictedPosition = targetPart.Position + (velocity * Config.PREDICTION_MULTIPLIER)
                
                local ray = Ray.new(Camera.CFrame.Position, 
                                  (predictedPosition - Camera.CFrame.Position).Unit * Config.MAX_DISTANCE)
                local hit, hitPosition = workspace:FindPartOnRayWithIgnoreList(
                    ray, 
                    {Players.LocalPlayer.Character}
                )
                
                if hit and (hitPosition - predictedPosition).Magnitude < 10 then
                    lookAt(predictedPosition)
                end
            end
        end
    end
end

local function init()
    createToggleButton()

    Cache.connections = {
        RunService.RenderStepped:Connect(safeFunction(mainUpdate)),
        workspace.DescendantAdded:Connect(safeFunction(onWorkspaceChanged)),
        Players.PlayerRemoving:Connect(safeFunction(onPlayerRemoved))
    }
end

init()
